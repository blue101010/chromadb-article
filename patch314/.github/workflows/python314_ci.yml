name: Python 3.14 Compatibility

on:
  push:
    branches: [main, master]
    paths:
      - "chromadb/config.py"
      - "patch314/**"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-py314:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.12", "3.13", "3.14-dev"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydantic>=2.0 pydantic-settings>=2.0
          pip install pytest>=7.0

      - name: Install chromadb (allow failure on 3.14-dev)
        continue-on-error: ${{ matrix.python-version == '3.14-dev' }}
        run: |
          pip install chromadb

      - name: Apply config.py patch (3.14 only)
        if: matrix.python-version == '3.14-dev'
        shell: python
        run: |
          import site, os, shutil
          sp = site.getsitepackages()[0]
          config_path = os.path.join(sp, "chromadb", "config.py")
          if os.path.exists(config_path):
              # Read original
              with open(config_path, "r") as f:
                  content = f.read()
              # Backup
              shutil.copy(config_path, config_path + ".bak")
              # Apply patch: replace the import block
              old_block = '''in_pydantic_v2 = False
          try:
              from pydantic import BaseSettings
          except ImportError:
              in_pydantic_v2 = True
              from pydantic.v1 import BaseSettings
              from pydantic.v1 import validator

          if not in_pydantic_v2:
              from pydantic import validator  # type: ignore # noqa'''

              new_block = '''import sys

          in_pydantic_v1 = False
          in_pydantic_v2 = False

          try:
              from pydantic_settings import BaseSettings
              from pydantic import field_validator
              in_pydantic_v2 = True

              def validator(field, *, pre=False, always=False, allow_reuse=False):
                  mode = "before" if pre else "after"
                  return field_validator(field, mode=mode)
          except ImportError:
              try:
                  from pydantic import BaseSettings
                  from pydantic import validator
                  in_pydantic_v1 = True
              except ImportError:
                  if sys.version_info >= (3, 14):
                      raise ImportError(
                          "ChromaDB requires pydantic-settings on Python 3.14+. "
                          "Install: pip install pydantic-settings>=2.0"
                      )
                  from pydantic.v1 import BaseSettings
                  from pydantic.v1 import validator
                  in_pydantic_v2 = True'''

              if old_block in content:
                  content = content.replace(old_block, new_block)
                  with open(config_path, "w") as f:
                      f.write(content)
                  print("Patch applied successfully")
              else:
                  print("WARNING: Could not find exact import block to patch")

      - name: Run patch tests
        run: |
          cd patch314
          python -m pytest tests/ -v --tb=short

      - name: Smoke test - import chromadb
        run: |
          python -c "import chromadb; print('chromadb imported successfully')"
          python -c "from chromadb.config import Settings; s = Settings(); print(f'Settings OK: {type(s)}')"

  test-pydantic-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pydantic-version: ["2.0", "2.6", "2.10", "2.12"]
        python-version: ["3.12", "3.14-dev"]
        exclude:
          # pydantic 2.0 doesn't support 3.14
          - pydantic-version: "2.0"
            python-version: "3.14-dev"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install specific pydantic version
        run: |
          pip install "pydantic==${{ matrix.pydantic-version }}.*"
          pip install pydantic-settings>=2.0
          pip install pytest

      - name: Test pydantic import compatibility
        run: |
          python -c "
          import pydantic
          print(f'pydantic version: {pydantic.__version__}')
          try:
              from pydantic_settings import BaseSettings
              print('pydantic-settings: OK')
          except ImportError:
              print('pydantic-settings: NOT INSTALLED')
          "
