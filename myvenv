#!/usr/bin/env bash
# myvenv.sh - helper to create and activate a Python venv when sourced from Git Bash on Windows.

set -euo pipefail

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    echo "myvenv must be sourced: source ./myvenv" >&2
    exit 1
fi

FORCE=false
ENV_DIR=".venv"
PYTHON_VERSION=""
PYTHON_BIN="${PYTHON_BIN:-python}"

# Parse arguments
for arg in "$@"; do
    if [[ "$arg" == "--force" ]]; then
        FORCE=true
    elif [[ "$arg" =~ ^--version=(.+)$ ]]; then
        PYTHON_VERSION="${BASH_REMATCH[1]}"
    else
        ENV_DIR="$arg"
    fi
done

# Set PYTHON_BIN based on --version flag
if [[ -n "$PYTHON_VERSION" ]]; then
    case "$PYTHON_VERSION" in
        3.12)
            PYTHON_BIN='C:\Python312\python.exe'
            ;;
        3.14)
            PYTHON_BIN='C:\Python314\python.exe'
            ;;
        *)
            echo "Error: Unsupported Python version '$PYTHON_VERSION'. Supported: 3.12, 3.14" >&2
            return 1
            ;;
    esac
fi

# If force flag is set and directory exists, remove it
if [[ "$FORCE" == true ]] && [[ -d "$ENV_DIR" ]]; then
    echo "Removing existing virtual environment '$ENV_DIR'..."
    rm -rf "$ENV_DIR"
fi

if [[ ! -d "$ENV_DIR" ]]; then
    echo "Creating virtual environment in '$ENV_DIR' using ${PYTHON_BIN}..."
    "$PYTHON_BIN" -m venv "$ENV_DIR"
    # Display the Python version used
    CREATED_VERSION=$("$PYTHON_BIN" --version 2>&1 | awk '{print $2}')
    echo "Virtual environment created with Python ${CREATED_VERSION}"
fi

ACTIVATE_PATH=""
if [[ -f "$ENV_DIR/Scripts/activate" ]]; then
    ACTIVATE_PATH="$ENV_DIR/Scripts/activate"
elif [[ -f "$ENV_DIR/bin/activate" ]]; then
    ACTIVATE_PATH="$ENV_DIR/bin/activate"
else
    echo "Could not find an activate script inside '$ENV_DIR'." >&2
    return 1
fi

# shellcheck disable=SC1090
source "$ACTIVATE_PATH"

python -m pip install --upgrade pip >/dev/null 2>&1 || true

# Enhance prompt to clearly show venv status
if [[ -n "$PS1" ]]; then
    ENV_NAME=$(basename "$ENV_DIR")
    export PS1="\[\033[1;32m\]($ENV_NAME)\[\033[0m\] $PS1"
fi

echo "Virtual environment '$ENV_DIR' is active."


alias spip='./spip'
